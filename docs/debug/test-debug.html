<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strava Integration Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .button:disabled { background: #6c757d; cursor: not-allowed; }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Strava Integration Debug Tool</h1>
        <p>This tool helps debug the Strava integration issues.</p>
        
        <div id="status" class="status info">Ready to start testing...</div>
        
        <div>
            <button class="button" onclick="testReactApp()">Test React App</button>
            <button class="button" onclick="testSupabaseConnection()">Test Supabase</button>
            <button class="button" onclick="testStravaAuth()">Test Strava Auth</button>
            <button class="button" onclick="testEdgeFunctions()">Test Edge Functions</button>
        </div>
        
        <div id="results"></div>
        
        <h3>Test Results Log</h3>
        <pre id="log"></pre>
    </div>

    <script>
        let logContent = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            logContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            document.getElementById('log').textContent = logContent;
            
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        async function testReactApp() {
            log('Testing React app accessibility...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080');
                if (response.ok) {
                    log('✓ React app is accessible on localhost:8080', 'success');
                    
                    // Test specific routes
                    const routes = [
                        '/test/strava-flow',
                        '/auth/strava/callback',
                        '/strava/success'
                    ];
                    
                    for (const route of routes) {
                        try {
                            const routeResponse = await fetch(`http://localhost:8080${route}`);
                            if (routeResponse.ok) {
                                log(`✓ Route ${route} is accessible`, 'success');
                            } else {
                                log(`⚠ Route ${route} returned ${routeResponse.status}`, 'warning');
                            }
                        } catch (err) {
                            log(`✗ Route ${route} failed: ${err.message}`, 'error');
                        }
                    }
                } else {
                    log(`✗ React app returned ${response.status}`, 'error');
                }
            } catch (error) {
                log(`✗ Cannot reach React app: ${error.message}`, 'error');
            }
        }
        
        async function testSupabaseConnection() {
            log('Testing Supabase connection...', 'info');
            
            // This would normally require the Supabase client
            // For now, just check if we can reach the API
            try {
                const supabaseUrl = 'https://ojjpslrhyutizwpvvngu.supabase.co';
                const response = await fetch(`${supabaseUrl}/health`);
                
                if (response.ok) {
                    log('✓ Supabase service is reachable', 'success');
                } else {
                    log(`⚠ Supabase returned ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`Supabase connection test: ${error.message}`, 'info');
            }
        }
        
        async function testStravaAuth() {
            log('Testing Strava OAuth configuration...', 'info');
            
            // Test if Strava OAuth endpoint is reachable
            try {
                const stravaAuthUrl = 'https://www.strava.com/oauth/authorize';
                const testUrl = `${stravaAuthUrl}?client_id=174654&response_type=code&redirect_uri=${encodeURIComponent('http://localhost:8080/auth/strava/callback')}&scope=read`;
                
                log(`Strava OAuth URL: ${testUrl}`, 'info');
                log('✓ Strava OAuth URL constructed successfully', 'success');
                log('Manual test: Click the URL above to test OAuth flow', 'info');
                
                // Test if we can reach Strava API
                const stravaResponse = await fetch('https://www.strava.com/api/v3', {
                    method: 'GET'
                });
                
                if (stravaResponse.status === 401) {
                    log('✓ Strava API is reachable (returns 401 as expected without auth)', 'success');
                } else {
                    log(`⚠ Strava API returned unexpected status: ${stravaResponse.status}`, 'warning');
                }
                
            } catch (error) {
                log(`✗ Strava API test failed: ${error.message}`, 'error');
            }
        }
        
        async function testEdgeFunctions() {
            log('Testing Supabase Edge Functions...', 'info');
            
            // Test edge function URLs
            const functions = [
                'strava-auth',
                'strava-activities', 
                'transfer-activity'
            ];
            
            const supabaseUrl = 'https://ojjpslrhyutizwpvvngu.supabase.co';
            
            for (const func of functions) {
                try {
                    const funcUrl = `${supabaseUrl}/functions/v1/${func}`;
                    const response = await fetch(funcUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ test: true })
                    });
                    
                    log(`Edge function ${func}: ${response.status} ${response.statusText}`, 
                         response.status < 500 ? 'success' : 'error');
                         
                } catch (error) {
                    log(`✗ Edge function ${func} failed: ${error.message}`, 'error');
                }
            }
        }
        
        // Auto-run initial tests
        window.onload = function() {
            log('Starting automated tests...', 'info');
            setTimeout(testReactApp, 1000);
        };
    </script>
</body>
</html>
// Full Supabase Dashboard control with Personal Access Token
import fetch from 'node-fetch';
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = "https://ojjpslrhyutizwpvvngu.supabase.co";
const SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qanBzbHJoeXV0aXp3cHZ2bmd1Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjIzMDI0NSwiZXhwIjoyMDcxODA2MjQ1fQ.Wm6AbiLNjIVM-T4a7TUhBMphb5EW9fMMLJC9-wSJNS4";
const PERSONAL_ACCESS_TOKEN = "sbp_554d2e7160eee173374d13e786b9fa1776634033";
const PROJECT_ID = "ojjpslrhyutizwpvvngu";

const supabase = createClient(SUPABASE_URL, SERVICE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false }
});

console.log('üöÄ SUPABASE DASHBOARD FULD KONTROL\n');

async function getProjectInfo() {
  console.log('1. üìä Henter project information...');
  
  try {
    const response = await fetch(`https://api.supabase.com/v1/projects/${PROJECT_ID}`, {
      headers: {
        'Authorization': `Bearer ${PERSONAL_ACCESS_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const project = await response.json();
      console.log('   ‚úÖ Project info hentet!');
      console.log(`   üìã Name: ${project.name}`);
      console.log(`   üìã Region: ${project.region}`);
      console.log(`   üìã Status: ${project.status}`);
      console.log(`   üìã Created: ${project.created_at}`);
      return project;
    } else {
      const error = await response.text();
      console.log('   ‚ùå Cannot get project info:', error);
      return null;
    }
  } catch (error) {
    console.log('   ‚ùå Error:', error.message);
    return null;
  }
}

async function getCurrentAuthConfig() {
  console.log('\n2. üîç Henter current auth configuration...');
  
  try {
    const response = await fetch(`https://api.supabase.com/v1/projects/${PROJECT_ID}/config/auth`, {
      headers: {
        'Authorization': `Bearer ${PERSONAL_ACCESS_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const config = await response.json();
      console.log('   ‚úÖ Auth config hentet!');
      console.log('   üìã Current settings:');
      console.log(`   - Site URL: ${config.SITE_URL || 'Not set'}`);
      console.log(`   - URI Allow List: ${config.URI_ALLOW_LIST || 'Not set'}`);
      console.log(`   - Email confirmation: ${config.MAILER_AUTOCONFIRM === 'false' ? 'Enabled' : 'Disabled'}`);
      return config;
    } else {
      const error = await response.text();
      console.log('   ‚ùå Cannot get auth config:', error);
      return null;
    }
  } catch (error) {
    console.log('   ‚ùå Error:', error.message);
    return null;
  }
}

async function updateAuthConfig() {
  console.log('\n3. ‚öôÔ∏è Updating auth configuration...');
  
  const newConfig = {
    SITE_URL: 'https://runaro.dk',
    URI_ALLOW_LIST: 'https://runaro.dk,https://runaro.dk/auth,https://runaro.dk/auth/callback,https://runaro.dk/',
    MAILER_AUTOCONFIRM: 'false', // Enable email confirmation
    EXTERNAL_EMAIL_ENABLED: 'true', // Enable built-in email
    SMTP_SENDER_NAME: 'Runaro',
    JWT_EXP: '3600',
    REFRESH_TOKEN_ROTATION_ENABLED: 'true',
    SECURITY_UPDATE_PASSWORD_REQUIRE_REAUTHENTICATION: 'false'
  };
  
  console.log('   üìù New configuration:');
  console.log(`   - Site URL: ${newConfig.SITE_URL}`);
  console.log(`   - URI Allow List: ${newConfig.URI_ALLOW_LIST}`);
  console.log(`   - Email confirmation: Enabled`);
  
  try {
    const response = await fetch(`https://api.supabase.com/v1/projects/${PROJECT_ID}/config/auth`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${PERSONAL_ACCESS_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(newConfig)
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('   üéâ AUTH CONFIGURATION UPDATED SUCCESSFULLY!');
      console.log('   ‚úÖ Site URL nu korrekt sat til: https://runaro.dk');
      console.log('   ‚úÖ Redirect URLs konfigureret');
      console.log('   ‚úÖ Email confirmation aktiveret');
      return true;
    } else {
      const error = await response.text();
      console.log('   ‚ùå Update failed:', error);
      
      // Try alternative endpoint
      console.log('   üîÑ Trying alternative endpoint...');
      return await tryAlternativeUpdate(newConfig);
    }
  } catch (error) {
    console.log('   ‚ùå Error:', error.message);
    return false;
  }
}

async function tryAlternativeUpdate(config) {
  const endpoints = [
    `https://api.supabase.com/v1/projects/${PROJECT_ID}/auth/config`,
    `https://api.supabase.com/v1/projects/${PROJECT_ID}/settings/auth`,
    `https://api.supabase.com/v1/projects/${PROJECT_ID}/config`
  ];
  
  for (const endpoint of endpoints) {
    console.log(`   üîÑ Trying: ${endpoint.split('/').pop()}`);
    
    try {
      const response = await fetch(endpoint, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${PERSONAL_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
      });
      
      if (response.ok) {
        console.log('   üéâ Alternative endpoint SUCCESS!');
        return true;
      } else {
        console.log(`   ‚ùå ${response.status}: ${await response.text()}`);
      }
    } catch (error) {
      console.log(`   ‚ùå Error: ${error.message}`);
    }
  }
  
  return false;
}

async function verifyConfigurationChange() {
  console.log('\n4. ‚úÖ Verificerer configuration changes...');
  
  // Wait a moment for changes to propagate
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  const updatedConfig = await getCurrentAuthConfig();
  
  if (updatedConfig) {
    const siteUrlCorrect = updatedConfig.SITE_URL === 'https://runaro.dk';
    const uriListCorrect = updatedConfig.URI_ALLOW_LIST && updatedConfig.URI_ALLOW_LIST.includes('https://runaro.dk');
    
    console.log('   üìä Configuration verification:');
    console.log(`   - Site URL correct: ${siteUrlCorrect ? '‚úÖ' : '‚ùå'}`);
    console.log(`   - URI Allow List correct: ${uriListCorrect ? '‚úÖ' : '‚ùå'}`);
    
    return siteUrlCorrect && uriListCorrect;
  }
  
  return false;
}

async function testNewConfiguration() {
  console.log('\n5. üß™ Testing new configuration...');
  
  try {
    const testEmail = `config-verify-${Date.now()}@gmail.com`;
    console.log(`   üìß Test email: ${testEmail}`);
    
    const { data, error } = await supabase.auth.signUp({
      email: testEmail,
      password: 'TestPassword123!',
      options: {
        data: {
          username: 'configtest',
          display_name: 'Config Test User',
          age: 25
        },
        emailRedirectTo: 'https://runaro.dk/auth'
      }
    });
    
    if (error) {
      console.log('   ‚ùå Test signup failed:', error.message);
      return false;
    }
    
    console.log('   ‚úÖ Test signup successful!');
    console.log(`   üìß Email confirmation needed: ${!data.session && !!data.user}`);
    
    if (!data.session && data.user) {
      console.log('   üéØ EMAIL SENDT!');
      console.log('   üì® Bekr√¶ftelsesmail burde nu pege til: https://runaro.dk/auth');
      console.log('   üö´ IKKE l√¶ngere til localhost:3000!');
    }
    
    // Clean up test user
    if (data.user) {
      console.log('   üßπ Cleaning up test user...');
      await supabase.auth.admin.deleteUser(data.user.id);
      console.log('   ‚úÖ Test user deleted');
    }
    
    return true;
    
  } catch (error) {
    console.log('   ‚ùå Test error:', error.message);
    return false;
  }
}

async function createPermanentControlSystem() {
  console.log('\n6. üõ†Ô∏è Opretter permanent control system...');
  
  const controlScript = `
// Claude Permanent Supabase Dashboard Control
const PERSONAL_ACCESS_TOKEN = "${PERSONAL_ACCESS_TOKEN}";
const PROJECT_ID = "${PROJECT_ID}";

import fetch from 'node-fetch';

export async function updateSiteURL(newUrl) {
  const config = { SITE_URL: newUrl };
  const response = await fetch(\`https://api.supabase.com/v1/projects/\${PROJECT_ID}/config/auth\`, {
    method: 'PUT',
    headers: {
      'Authorization': \`Bearer \${PERSONAL_ACCESS_TOKEN}\`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(config)
  });
  return response.ok;
}

export async function getAuthConfig() {
  const response = await fetch(\`https://api.supabase.com/v1/projects/\${PROJECT_ID}/config/auth\`, {
    headers: { 'Authorization': \`Bearer \${PERSONAL_ACCESS_TOKEN}\` }
  });
  return response.ok ? await response.json() : null;
}

export async function enableEmailConfirmation() {
  const config = { MAILER_AUTOCONFIRM: 'false' };
  const response = await fetch(\`https://api.supabase.com/v1/projects/\${PROJECT_ID}/config/auth\`, {
    method: 'PUT',
    headers: {
      'Authorization': \`Bearer \${PERSONAL_ACCESS_TOKEN}\`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(config)
  });
  return response.ok;
}

console.log('Claude Dashboard Control System loaded!');
  `;
  
  try {
    require('fs').writeFileSync('claude_dashboard_control.js', controlScript);
    console.log('   ‚úÖ Permanent control system created!');
    console.log('   üìã Available functions:');
    console.log('   - updateSiteURL(url) - Change site URL');
    console.log('   - getAuthConfig() - Get current config');
    console.log('   - enableEmailConfirmation() - Enable/disable email confirmation');
    return true;
  } catch (error) {
    console.log('   ‚ùå Could not create control system:', error.message);
    return false;
  }
}

// Main execution
async function main() {
  console.log('üéØ CLAUDE DASHBOARD CONTROL SYSTEM');
  console.log('==================================');
  console.log('Nu f√•r Claude fuld kontrol over Supabase Dashboard!\n');
  
  const projectInfo = await getProjectInfo();
  
  if (!projectInfo) {
    console.log('‚ùå Cannot access project - check Personal Access Token');
    return;
  }
  
  const currentConfig = await getCurrentAuthConfig();
  const updateSuccess = await updateAuthConfig();
  
  if (updateSuccess) {
    const verified = await verifyConfigurationChange();
    const tested = await testNewConfiguration();
    await createPermanentControlSystem();
    
    console.log('\nüèÅ RESULTAT:');
    console.log('=============');
    
    if (verified && tested) {
      console.log('üéâüéâ KOMPLET SUCCESS! üéâüéâ');
      console.log('');
      console.log('‚úÖ SITE URL ER NU KORREKT KONFIGURERET!');
      console.log('   - Site URL: https://runaro.dk ‚úÖ');
      console.log('   - Redirect URLs: https://runaro.dk/auth ‚úÖ');
      console.log('   - Email confirmation: Aktiveret ‚úÖ');
      console.log('');
      console.log('üîó BEKR√ÜFTELSESLINKS PEGER NU TIL KORREKT URL!');
      console.log('');
      console.log('üöÄ KLAR TIL BRUG:');
      console.log('1. G√• til https://runaro.dk/auth');
      console.log('2. Opret bruger wahlers3@hotmail.com igen');
      console.log('3. Tjek email - linket vil NU pege til https://runaro.dk/auth');
      console.log('4. Klik linket og bekr√¶ft (virker nu!)');
      console.log('5. Log ind og se "Velkommen [navn]!" p√• forsiden');
      console.log('');
      console.log('üõ†Ô∏è CLAUDE HAR NU PERMANENT DASHBOARD KONTROL!');
      console.log('   - claude_dashboard_control.js oprettet');
      console.log('   - Kan √¶ndre alle Supabase indstillinger fremover');
      
    } else {
      console.log('‚ö†Ô∏è Konfiguration opdateret, men verificering usikker');
      console.log('Test manual signup for at verificere');
    }
    
  } else {
    console.log('‚ùå Kunne ikke opdatere konfiguration');
    console.log('Check Personal Access Token permissions');
  }
  
  console.log(`\nüìä Dashboard: https://supabase.com/dashboard/project/${PROJECT_ID}`);
  console.log('üí° Claude har nu maksimal kontrol over din Supabase! üöÄ');
}

main().catch(console.error);